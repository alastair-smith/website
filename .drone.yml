kind: pipeline
name: default

.deployment-variables: &deployment-variables
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET_ACCESS_KEY
    AWS_DEFAULT_REGION: eu-west-1
    STATE_BUCKET:
      from_secret: STATE_BUCKET
    TF_VAR_git_branch: "$DRONE_BRANCH"
    TF_VAR_git_commit: "$DRONE_COMMIT_SHA"
    TF_VAR_git_repository: "$DRONE_COMMIT_LINK"
    WORKSPACE: "$(([ $DRONE_BRANCH == \"master\" ] && echo \"master\") || echo \"feature\")"

.node-image: &node-image
  image: node:10-alpine

.terraform-image: &terraform-image
  image: hashicorp/terraform:light
  entrypoint: [""]

steps:
- name: check dependencies
  <<: *node-image
  commands:
    - npm audit

- name: install dependencies
  <<: *node-image
  commands:
    - npm ci

- name: lint javascript
  <<: *node-image
  commands:
    - npm run linter:js

- name: prepare deploy
  <<: *terraform-image
  <<: *deployment-variables
  commands:
    - cd infrastructure
    - echo -n $AWS_ACCESS_KEY_ID | wc -m
    - terraform init --backend-config="bucket=$STATE_BUCKET"
    - terraform workspace select $WORKSPACE || terraform workspace new $WORKSPACE
    - terraform plan

- name: deploy
  <<: *terraform-image
  <<: *deployment-variables
  commands:
    - cd infrastructure
    - terraform apply -y
    